### План вывода в продакшн (MVP → Production)

#### 1) Безопасность и защита (высокий приоритет)
- **Rate limiting**: уже внедрён на SQLite. Вынести лимиты в настройки БД и UI админки.
- **Security headers + CORS**: уже включены для API. Зафиксировать `ALLOWED_ORIGINS` в проде.
- **Аутентификация админки**: использовать `ADMIN_EMAIL`/`ADMIN_PASSWORD` из env; опционально — смена на хэш пароля и IP allowlist.
- **Валидация env на старте**: добавить проверку критичных переменных (OPENAI_*, QDRANT_*, NEXTAUTH_SECRET, ADMIN_*, DATA_DIR/UPLOADS_DIR, WS-порты).
- **Ошибки/логирование**: подключить Sentry; перейти на структурные логи (pino) с уровнями и кореляционными id.

#### 2) Персистентность и данные
- **SQLite**: закрепить volume для `DATA_DIR` и `uploads/`; настроить ежедневные бэкапы (cron + rsync/tar) и ротацию.
- **Миграции схемы**: оформить скрипты миграций (существующие init сохраняем), фиксировать изменения БД.
- **Файлы**: пока локально. Следующий шаг — S3/R2 presigned uploads (для масштабирования/надёжности).

#### 3) Qdrant и векторный поиск
- Проверить доступы Qdrant Cloud (URL, API key), коллекцию и размерность под выбранную модель эмбеддингов.
- Включить/выключить multivector режим через настройки; проверить скорость и стоимость эмбеддингов.
- Добавить healthcheck Qdrant (пинг коллекции) и graceful fallback без RAG (уже есть) c метрикой.

#### 4) Производительность и лимиты затрат
- Ограничить `max_tokens`, температуру, K, timeouts через настройки БД (дефолты безопасные).
- Включить тайм-ауты внешних вызовов (OpenAI/Qdrant) и ретраи с backoff.
- Кэшировать «настройки» в памяти с малым TTL (есть кеш в `SettingsService`).

#### 5) WebSocket и стриминг
- Прод: выставить `NEXT_PUBLIC_WEBSOCKET_URL` и `WEBSOCKET_HTTP_URL`; актуализировать `ALLOWED_ORIGINS`.
- Проверить обратный прокси (NGINX/Caddy) и sticky‑sessions не требуются (отдельный WS процесс уже есть).
- На клиентах — автоматическое переподключение уже есть; добавить повтор HTTP‑доставки при 404 клиента (опционально).

#### 6) DevOps/деплой
- Среда: Node LTS, PM2/системный сервис. Использовать `ecosystem.config.cjs`.
- CI/CD: билд, загрузка env, рестарт процессов; шаги smoke‑тестов (GET `/api/test`, `/api/test-env`).
- Secrets: хранить env в менеджере секретов (1Password/Vault/версионирование вне гита).

#### 7) Наблюдаемость
- Sentry (server + client), алерты по 5xx и превышению времени ответа.
- Метрики: базовые (RPS, 4xx/5xx, latency по эндпоинтам), счётчики лимитов, длина очередей/долгих операций.
- Дашборд логов/метрик (например, Grafana/Loki или Logtail/Datadog).

#### 8) Контент и UX
- Отображать текущие лимиты/размеры в UI загрузки (чтение из `/api/settings/max-file-size`).
- Понятные сообщения об ошибках (429/413), рекомендации по повтору.
- Страница статуса в админке: Qdrant доступность, кол-во документов, sync‑очередь.

#### 9) Документация и runbook
- README для прод запуска: переменные, порты, команды (`npm run start:pm2`, бэкапы, восстановление).
- Runbook: пересоздание коллекции Qdrant, пересинхронизация, очистка дубликатов, ротация бэкапов.

---

### Checklist (минимум для запуска)
- [ ] Прописаны env: `OPENAI_API_KEY`, `QDRANT_URL`, `QDRANT_API_KEY`, `QDRANT_COLLECTION_NAME`,
      `NEXTAUTH_SECRET`, `ADMIN_EMAIL`, `ADMIN_PASSWORD`, `DATA_DIR`, `UPLOADS_DIR`,
      `NEXT_PUBLIC_SITE_URL`, `ALLOWED_ORIGINS`, `WEBSOCKET_PORT`, `WEBSOCKET_HTTP_PORT`,
      `NEXT_PUBLIC_WEBSOCKET_URL` или `NEXT_PUBLIC_WEBSOCKET_PORT`.
- [ ] Включены security headers и CORS (готово), проверены домены.
- [ ] Лимиты запросов и загрузок включены (готово); значения — из настроек БД.
- [ ] Бэкап БД и `uploads/` настроен; проверено восстановление.
- [ ] Qdrant коллекция создана и соответствует модели эмбеддингов.
- [ ] Sentry подключён, алерты настроены.
- [ ] PM2 запуск и автоперезапуск, health/smoke‑проверки проходят.

---

### Опционально (через 1–2 итерации)
- Перенос файлов в S3/R2 (presigned uploads) с CDN.
- Переключаемый rate‑limit backend (SQLite → Redis) через `RATE_LIMIT_STORE`.
- Доп. роли пользователей, аудит изменений настроек, 2FA для админки.
