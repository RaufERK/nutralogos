# –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –≤ RAG-—á–∞—Ç

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

‚úÖ **–ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:**
- –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è RAG-—Å–∏—Å—Ç–µ–º–∞ —Å LangChain + OpenAI + Qdrant
- API endpoint `/api/ask` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
- React —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —á–∞—Ç–∞
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–º
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

‚ùå **–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è real-time –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- Streaming API endpoint –¥–ª—è OpenAI
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- **–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º** (`/api/ask`) - –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- **–°—Ç—Ä–∏–º–∏–Ω–≥ —Ä–µ–∂–∏–º** (`/api/ask-stream` + WebSocket) - –Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- **WebSocket**: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Node.js `ws` –∏–ª–∏ `socket.io`
- **Streaming API**: OpenAI Chat Completions —Å `stream: true`
- **–ö–ª–∏–µ–Ω—Ç**: WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ + React —Å–æ—Å—Ç–æ—è–Ω–∏–µ

## –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å

#### 1.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install ws socket.io @types/ws
```

#### 1.2 WebSocket —Å–µ—Ä–≤–µ—Ä
**–§–∞–π–ª:** `src/lib/websocket-server.ts`
- –°–æ–∑–¥–∞—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Ç–∏–ø–∞–º

#### 1.3 Streaming API endpoint
**–§–∞–π–ª:** `src/app/api/ask-stream/route.ts`
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç —á—Ç–æ –∏ `/api/ask`
- –í—ã–ø–æ–ª–Ω—è–µ—Ç RAG –ø–æ–∏—Å–∫ (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –æ—Å—Ç–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º)
- –í—ã–∑—ã–≤–∞–µ—Ç OpenAI —Å `stream: true`
- –ü–µ—Ä–µ–¥–∞–µ—Ç —á–∞–Ω–∫–∏ —á–µ—Ä–µ–∑ WebSocket

#### 1.4 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangChain
**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:** `src/lib/langchain/llm.ts`
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `createStreamingLLM()`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ streaming —Ä–µ–∂–∏–º–∞ –≤ RAG —Ü–µ–ø–æ—á–∫–µ

### –≠—Ç–∞–ø 2: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

#### 2.1 WebSocket –∫–ª–∏–µ–Ω—Ç
**–§–∞–π–ª:** `src/hooks/useWebSocket.ts`
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ

#### 2.2 Streaming UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:** `src/app/page.tsx`
- –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å "–û–±—ã—á–Ω—ã–π/–°—Ç—Ä–∏–º–∏–Ω–≥ —Ä–µ–∂–∏–º"
- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- –ê–Ω–∏–º–∞—Ü–∏—è "–ø–µ—á–∞—Ç–∞—é—â–µ–≥–æ" —Ç–µ–∫—Å—Ç–∞

#### 2.3 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:** `src/hooks/useChatContext.ts`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ streaming —Å–æ–æ–±—â–µ–Ω–∏–π
- –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

### –≠—Ç–∞–ø 3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### 3.1 Next.js –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:** `next.config.ts`
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
- Proxy –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è development

#### 3.2 Environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
**–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:**
```
WEBSOCKET_PORT=3001
ENABLE_STREAMING=true
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å
2. –ö–ª–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
3. –°–µ—Ä–≤–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç RAG –ø–æ–∏—Å–∫ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
4. –°–µ—Ä–≤–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç OpenAI —Å stream: true
5. –ö–∞–∂–¥—ã–π —á–∞–Ω–∫ –æ—Ç OpenAI –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket
6. –ö–ª–∏–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —á–∞–Ω–∫–∏ –≤ real-time
7. –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–∏
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π

```typescript
// –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
type WSMessage = 
  | { type: 'start', messageId: string, question: string }
  | { type: 'chunk', messageId: string, content: string }
  | { type: 'sources', messageId: string, sources: Document[] }
  | { type: 'complete', messageId: string }
  | { type: 'error', messageId: string, error: string }
```

### –ü—Ä–∏–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞

```typescript
// Streaming endpoint
export async function POST(request: NextRequest) {
  const { question, context, messageId } = await request.json()
  
  // 1. –í—ã–ø–æ–ª–Ω—è–µ–º RAG –ø–æ–∏—Å–∫ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  const ragChain = createEnhancedRAGChain()
  const documents = await ragChain.getDocuments(question)
  
  // 2. –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –Ω–∞—á–∞–ª–µ
  wsServer.send(messageId, { type: 'start', messageId, question })
  
  // 3. Streaming –æ—Ç OpenAI
  const stream = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [...],
    stream: true,
  })
  
  // 4. –ü–µ—Ä–µ–¥–∞–µ–º —á–∞–Ω–∫–∏
  for await (const chunk of stream) {
    const content = chunk.choices[0]?.delta?.content
    if (content) {
      wsServer.send(messageId, { type: 'chunk', messageId, content })
    }
  }
  
  // 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º
  wsServer.send(messageId, { type: 'sources', messageId, sources: documents })
  wsServer.send(messageId, { type: 'complete', messageId })
}
```

### –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞

```typescript
// React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è streaming
const [streamingMessage, setStreamingMessage] = useState('')

useEffect(() => {
  wsClient.on('chunk', (data) => {
    if (data.messageId === currentMessageId) {
      setStreamingMessage(prev => prev + data.content)
    }
  })
  
  wsClient.on('complete', (data) => {
    // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    finalizeMessage(data.messageId, streamingMessage)
  })
}, [])
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–π API –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å  
‚úÖ **–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ** - –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥  
‚úÖ **RAG –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä—ã–º  
‚úÖ **–ñ–∏–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—Ç–≤–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - WebSocket –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π  

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –†–∞–∑—Ä—ã–≤ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
**–†–µ—à–µ–Ω–∏–µ:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö streaming —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—à–∏–±–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
**–†–µ—à–µ–Ω–∏–µ:** Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## –ü–æ—Ä—è–¥–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

1. **–§–∞–∑–∞ 1:** –ë–∞–∑–æ–≤–∞—è WebSocket –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
2. **–§–∞–∑–∞ 2:** Streaming API endpoint
3. **–§–∞–∑–∞ 3:** –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
4. **–§–∞–∑–∞ 4:** UI/UX –ø–æ–ª–∏—Ä–æ–≤–∫–∞
5. **–§–∞–∑–∞ 5:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

## –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

- **–ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** 4-6 —á–∞—Å–æ–≤
- **–ü–æ–ª–∏—Ä–æ–≤–∫–∞ UI:** 2-3 —á–∞—Å–∞  
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** 1-2 —á–∞—Å–∞
- **–û–±—â–µ–µ –≤—Ä–µ–º—è:** 7-11 —á–∞—Å–æ–≤

---

**–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** üöÄ

–≠—Ç–æ—Ç –ø–ª–∞–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.
